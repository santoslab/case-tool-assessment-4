// Do not edit this file as it will be overwritten if HAMR codegen is rerun

import <std_connector.camkes>;
import <global-connectors.camkes>;
import <seL4VMDTBPassthrough.idl4>;
import <FileServerInterface.camkes>;
import <FileServer/FileServer.camkes>;
import <SerialServer/SerialServer.camkes>;
import <TimeServer/TimeServer.camkes>;
import <vm-connectors.camkes>;
import <devices.camkes>;
import "components/Pacer/Pacer.camkes";
import "components/T1_i_p1_t1/T1_i_p1_t1.camkes";
import "components/T2_i_p2_t2/T2_i_p2_t2.camkes";
import "components/VM_P3_i_p3/VM_P3_i_p3.camkes";

assembly {
  composition {
    component T1_i_p1_t1 p1_t1;
    component T2_i_p2_t2 p2_t2;
    component VM_P3_i_p3 vmp3;
    component FileServer fserv; // expansion of macro VM_GENERAL_COMPOSITION_DEF. See https://github.com/seL4/camkes-vm/blob/64690e8db397f69ece88866e79a9f2942c3c7015/components/VM_Arm/configurations/vm.h#L124

    // expansion of macro VM_VIRTUAL_SERIAL_COMPONENTS_DEF. See https://github.com/seL4/camkes-vm/blob/64690e8db397f69ece88866e79a9f2942c3c7015/components/VM_Arm/configurations/vm.h#L147
    component SerialServer serial;
    component TimeServer time_server;

    component Pacer pacer;

    // expansion of macro VM_COMPONENT_CONNECTIONS_DEF. See https://github.com/seL4/camkes-vm/blob/64690e8db397f69ece88866e79a9f2942c3c7015/components/VM_Arm/configurations/vm.h#L117
    connection seL4RPCDataport conn1(from vmp3.fs, to fserv.fs_ctrl);
    connection seL4GlobalAsynch conn2(from vmp3.notification_ready_connector, to vmp3.notification_ready);

    connection seL4VMDTBPassthrough conn3(from vmp3.dtb_self, to vmp3.dtb);

    // expansion of macro VM_VIRTUAL_SERIAL_COMPONENTS_DEF. See https://github.com/seL4/camkes-vm/blob/64690e8db397f69ece88866e79a9f2942c3c7015/components/VM_Arm/configurations/vm.h#L149
    connection seL4TimeServer conn4(from serial.timeout, to time_server.the_timer);

    // expansion of macro PER_VM_VIRTUAL_SERIAL_CONNECTIONS_DEF. See https://github.com/seL4/camkes-vm/blob/64690e8db397f69ece88866e79a9f2942c3c7015/components/VM_Arm/configurations/vm.h#L151
    connection seL4SerialServer conn5(from vmp3.batch, to serial.processed_batch);
    connection seL4SerialServer conn6(from vmp3.serial_getchar, to serial.getchar);

    connection seL4SharedData conn7(from p1_t1.sb_write_port, to p2_t2.sb_read_port);
    connection seL4SharedDataWithCaps conn8(from p2_t2.sb_write_port, to vmp3.sb_read_port);
    connection seL4Notification conn9(from pacer.tick, to pacer.tock);
    connection seL4Notification conn10(from pacer.period, to p1_t1.sb_pacer_notification);
    connection seL4Notification conn11(from pacer.period, to p2_t2.sb_pacer_notification);
    connection seL4GlobalAsynch conn12(from pacer.period_to_vmp3_notification, to vmp3.sb_pacer_period_notification);
    connection seL4SharedDataWithCaps conn13(from pacer.period_to_vmp3_queue, to vmp3.sb_pacer_period_queue);
  }

  configuration {
    p1_t1._domain = 2;
    p2_t2._domain = 3;

    // expansion of macro VM_VIRTUAL_SERIAL_GENERAL_CONFIGURATION_DEF. See https://github.com/seL4/camkes-vm/blob/64690e8db397f69ece88866e79a9f2942c3c7015/components/VM_Arm/configurations/vm.h#L155
    time_server.timers_per_client = 1;
    time_server.priority = 255;
    time_server.simple = true;

    vmp3.num_extra_frame_caps = 0;
    vmp3.extra_frame_map_address = 0;
    vmp3.cnode_size_bits = 23;
    vmp3.simple_untyped24_pool = 12;
    fserv.heap_size = 0x30000; // expansion of macro VM_GENERAL_CONFIGURATION_DEF. See https://github.com/seL4/camkes-vm/blob/64690e8db397f69ece88866e79a9f2942c3c7015/components/VM_Arm/configurations/vm.h#L128

    // expansion of macro VM_CONFIGURATION_DEF. See https://github.com/seL4/camkes-vm/blob/64690e8db397f69ece88866e79a9f2942c3c7015/components/VM_Arm/configurations/vm.h#L131
    vmp3.fs_shmem_size = 0x100000;
    vmp3.global_endpoint_base = 1 << 27;
    vmp3.asid_pool = true;
    vmp3.simple = true;
    vmp3.base_prio = 100;
    vmp3._priority = 101;
    vmp3.sem_value = 0;
    vmp3.heap_size = 0x300000;


    // expansion of macro PER_VM_VIRTUAL_SERIAL_CONFIGURATION_DEF. See https://github.com/seL4/camkes-vm/blob/64690e8db397f69ece88866e79a9f2942c3c7015/components/VM_Arm/configurations/vm.h#L164
    vmp3.serial_getchar_shmem_size = 0x1000;
    vmp3.batch_shmem_size = 0x1000;

    vmp3._domain = 4;
    p1_t1.sb_write_port_access = "W";
    p2_t2.sb_read_port_access = "R";
    p2_t2.sb_write_port_access = "W";
    vmp3.sb_read_port_access = "R";
    pacer._domain = 1;
    pacer.period_to_vmp3_queue_access = "W";
    vmp3.sb_pacer_period_queue_access = "R";
  }
}
